<?xml version="1.0" encoding="UTF-8"?>
<persistence xmlns="https://jakarta.ee/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="https://jakarta.ee/xml/ns/persistence https://jakarta.ee/xml/ns/persistence/persistence_3_0.xsd"
             version="3.0">

    <!-- PU para el esquema central -->
  <persistence-unit name="PU_CENTRAL" transaction-type="JTA">
      <jta-data-source>java:/jdbc/DS_CENTRAL</jta-data-source>
        <properties>
            <!-- Hibernate -->
            <property name="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
            <property name="hibernate.hbm2ddl.auto" value="validate"/>
            <property name="hibernate.show_sql" value="false"/>
            <property name="hibernate.format_sql" value="true"/>
            <property name="jakarta.persistence.jdbc.url" value="jdbc:postgresql://10.1.3.13:5432/hcen"/>
        </properties>
  </persistence-unit>

 <persistence-unit name="PU_MASTER" transaction-type="JTA">
    <jta-data-source>java:/jdbc/DS_MASTER</jta-data-source>

    <!-- No necesitás entidades mapeadas, salvo que registres logs de aprovisionamiento -->
      <properties>
          <property name="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
          <property name="hibernate.hbm2ddl.auto" value="none"/>
          <property name="hibernate.show_sql" value="false"/>
          <property name="hibernate.format_sql" value="true"/>
          <property name="jakarta.persistence.jdbc.url" value="jdbc:postgresql://10.1.3.13:5432/hcen"/>
      </properties>
  </persistence-unit> 

  <!-- PU para los esquemas de los tenants -->
  <persistence-unit name="PU_TENANT" transaction-type="JTA">
      <jta-data-source>java:/jdbc/DS_TENANT</jta-data-source>

      <class>uy.edu.fing.tse.entidades.Paciente</class>
      <class>uy.edu.fing.tse.entidades.Profesional</class>
      <class>uy.edu.fing.tse.entidades.DocumentoClinico</class>
      <!-- Agregá acá todas las entidades clínicas comunes a todos los tenants -->
      <properties>
          <!-- Hibernate -->
          <property name="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>
          <property name="hibernate.hbm2ddl.auto" value="validate"/>
          <property name="hibernate.show_sql" value="false"/>
          <property name="hibernate.format_sql" value="true"/>
          <property name="jakarta.persistence.jdbc.url" value="jdbc:postgresql://10.1.3.13:5432/hcen"/>
      </properties>
  </persistence-unit>

  <!-- PU multitenant por esquema -->
  <persistence-unit name="PU_TENANT" transaction-type="JTA">
    <jta-data-source>java:/jdbc/PrestadorDS</jta-data-source>
    <properties>
      <property name="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"/>

      <!-- Multitenancy por SCHEMA (deshabilitado hasta implementar los providers) -->
      <!--
      <property name="hibernate.multiTenancy" value="SCHEMA"/>
      <property name="hibernate.multi_tenant_connection_provider"
                value="uy.edu.tse.infra.SchemaConnectionProvider"/>
      <property name="hibernate.tenant_identifier_resolver"
                value="uy.edu.tse.infra.TenantResolver"/>
      -->

      <!-- DEV: update | PROD: validate -->
      <property name="hibernate.hbm2ddl.auto" value="validate"/>
      <property name="hibernate.show_sql" value="true"/>
      <property name="hibernate.format_sql" value="true"/>
      <property name="jakarta.persistence.jdbc.url" value="jdbc:postgresql://10.1.3.13:5432/hcen"/>
    </properties>
  </persistence-unit>
</persistence>


data-source add \
 --name=DS_MASTER \
 --driver-name=postgresql-42.7.8.jar \
 --jndi-name=java:/jdbc/DS_MASTER \
 --connection-url=jdbc:postgresql://10.1.3.13:5432/hcen \
 --user-name=hcen_master --password=hcen_pass \
 --validate-on-match=true --background-validation=false \
 --max-pool-size=10 --min-pool-size=1 \
 --enabled=true

data-source add \
 --name=DS_CENTRAL \
 --driver-name=postgresql-42.7.8.jar \
 --jndi-name=java:/jdbc/DS_CENTRAL \
 --connection-url="jdbc:postgresql://10.1.3.13:5432/hcen?currentSchema=central" \
 --user-name=hcen_user --password=hcen_pass \
 --validate-on-match=true --background-validation=false \
 --max-pool-size=20 --min-pool-size=2 \
 --enabled=true

data-source add \
 --name=DS_TENANT \
 --driver-name=postgresql-42.7.8.jar \
 --jndi-name=java:/jdbc/DS_TENANT \
 --connection-url=jdbc:postgresql://10.1.3.13:5432/hcen \
 --user-name=hcen_tenant --password=hcen_pass \
 --validate-on-match=true --background-validation=false \
 --max-pool-size=20 --min-pool-size=2 \
 --enabled=true
